default_platform(:ios)

platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    # CI environment setup
    setup_ci

    # API Key setup
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_KEY_CONTENT"],
      is_key_content_base64: false
    )

    # Clean previous builds
    clear_derived_data
    
    # Fetch/Create Certificate
    get_certificates(
      api_key: api_key,
      development: false,
      generate_apple_certs: true # Try to create if missing
    )

    # Fetch/Create Provisioning Profile
    get_provisioning_profile(
      api_key: api_key,
      development: false,
      app_identifier: "com.metestudios.flowifygame",
      force: true # Force refresh profile since certs were cleaned
    )

    # Set Team ID in the project file
    update_project_team(
      path: "App.xcodeproj",
      teamid: "ERUH5NNQUB"
    )

    # Force Pods to use the correct team or skip signing for resource bundles
    sh("sed -i '' 's/DEVELOPMENT_TEAM = \"\";/DEVELOPMENT_TEAM = \"ERUH5NNQUB\";/g' Pods/Pods.xcodeproj/project.pbxproj || true")

    # Build the app
    gym(
      scheme: "App",
      workspace: "App.xcworkspace",
      output_directory: "build",
      output_name: "App.ipa",
      include_bitcode: false,
      export_method: "app-store",
      xcargs: "CODE_SIGNING_REQUIRED=YES CODE_SIGNING_ALLOWED=YES",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "com.metestudios.flowifygame" => ENV["SIGH_NAME"] # Use the profile name created in the previous step
        }
      }
    )

    # Upload to TestFlight
    pilot(
      api_key: api_key,
      ipa: "build/App.ipa",
      skip_waiting_for_build_processing: true
    )
  end
end
